<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora SRM Ratio – Tumores Renales</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#111827" />
<link rel="icon" href="icons/icon-192.png" />
<style>
  :root{--bg:#f6f7fb;--fg:#111827;--muted:#6b7280;--card:#ffffff;--accent:#111827;--ok:#065f46;--warn:#92400e}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:980px;margin:0 auto;padding:24px}
  h1{font-size:clamp(22px,3vw,30px);margin:0 0 6px;font-weight:800}
  p.lead{color:var(--muted);margin:0 0 18px}
  .grid{display:grid;gap:16px} @media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="number"],input[type="date"],select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .btn{border:1px solid #e5e7eb;background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .kpi{background:#f3f4f6;border-radius:12px;padding:12px}
  .kpi .t{font-size:12px;color:var(--muted)} .kpi .v{font-size:20px;font-weight:700}
  table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{font-size:13px;text-align:left;padding:10px 12px}
  tbody tr{background:#fff;border:1px solid #e5e7eb} tbody tr>td:first-child{border-radius:10px 0 0 10px} tbody tr>td:last-child{border-radius:0 10px 10px 0}
  .footer{font-size:12px;color:var(--muted);margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Calculadora SRM Ratio</h1>
  <p class="lead">Estimación de <strong>ratio D₁/D₀</strong>, <strong>mm/año</strong>, <strong>% anualizado</strong> y <strong>VDT</strong> (opcional, esfera). Los datos se guardan localmente.</p>

  <div class="grid grid-2">
    <div class="card">
      <h3 style="margin-top:0">Entradas</h3>
      <div class="row-2">
        <div><label>Fecha basal</label><input type="date" id="date0" /></div>
        <div><label>Fecha actual</label><input type="date" id="date1" /></div>
      </div>
      <div class="row-2" style="margin-top:8px">
        <div><label>D₀ (mm)</label><input type="number" step="0.1" id="d0" placeholder="p. ej., 18" /></div>
        <div><label>D₁ (mm)</label><input type="number" step="0.1" id="d1" placeholder="p. ej., 21" /></div>
      </div>
      <div style="margin-top:8px"><label><input type="checkbox" id="useVol" /> Calcular VDT (asumir esfera)</label></div>
      <div class="row-2" id="volRow" style="display:none;margin-top:8px">
        <div><label>Volumen basal (ml)</label><input type="number" id="v0" step="0.01" disabled /></div>
        <div><label>Volumen actual (ml)</label><input type="number" id="v1" step="0.01" disabled /></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="clearBtn">Limpiar</button>
        <button class="btn primary" id="saveBtn">Guardar caso</button>
        <button class="btn" id="exportBtn">Exportar CSV</button>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Resultados</h3>
      <div class="grid">
        <div class="kpi"><div class="t">Intervalo</div><div class="v" id="kYears">—</div></div>
        <div class="kpi"><div class="t">Ratio D₁/D₀</div><div class="v" id="kRatio">—</div></div>
        <div class="kpi"><div class="t">Δ total</div><div class="v" id="kDelta">—</div></div>
        <div class="kpi"><div class="t">mm/año</div><div class="v" id="kLin">—</div></div>
        <div class="kpi"><div class="t">% anual</div><div class="v" id="kRel">—</div></div>
        <div class="kpi"><div class="t">VDT</div><div class="v" id="kVDT">—</div></div>
      </div>
      <div class="footer">Umbrales orientativos: ≥ 5 mm/año o VDT &lt; 12 meses → considerar crecimiento acelerado. Ajustar a protocolo local.</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin-top:0">Casos guardados (local)</h3>
    <table>
      <thead><tr><th>Paciente/ID</th><th>Fechas</th><th>D₀→D₁</th><th>Ratio</th><th>Δ%</th><th>mm/año</th><th>%/año</th><th>VDT</th><th></th></tr></thead>
      <tbody id="casesTbody"></tbody>
    </table>
    <div class="footer">Los casos se almacenan en <code>localStorage</code>. Evitá datos identificatorios.</div>
  </div>

  <p class="footer">Fórmulas: ratio = D₁/D₀; Δ% = (D₁−D₀)/D₀; anualizado = (D₁/D₀)^(1/años)−1; mm/año = (D₁−D₀)/años; VDT = ln(2)/k, con k = (ln V₁−ln V₀)/años y V = 4/3·π·(D/2)³.</p>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const date0=$('date0'), date1=$('date1'), d0=$('d0'), d1=$('d1'), useVol=$('useVol');
  const v0=$('v0'), v1=$('v1');
  const kYears=$('kYears'), kRatio=$('kRatio'), kDelta=$('kDelta'), kLin=$('kLin'), kRel=$('kRel'), kVDT=$('kVDT');
  const volRow=$('volRow');

  function yearsBetween(a,b){ if(!a||!b) return NaN; const A=new Date(a), B=new Date(b);
    if(isNaN(A)||isNaN(B)) return NaN; return (B-A)/(1000*60*60*24*365.25); }
  function volSphere(d){ const r=d/2; return (4/3)*Math.PI*r*r*r; }
  function mm3ToMl(x){ return x/1000; }
  function fmt(x,d=2){ return Number.isFinite(x)? x.toFixed(d) : '—'; }

  function recalc(){
    const Y = yearsBetween(date0.value, date1.value);
    const D0 = parseFloat(d0.value), D1 = parseFloat(d1.value);

    kYears.textContent = fmt(Y,3) + (Number.isFinite(Y)?' años':'');

    let ratio=NaN, deltaPct=NaN, lin=NaN, rel=NaN;
    if(Number.isFinite(D0) && Number.isFinite(D1) && D0>0){
      ratio = D1/D0;
      deltaPct = (D1-D0)/D0*100;
      if(Number.isFinite(Y) && Y>0){
        lin = (D1-D0)/Y;
        rel = (Math.pow(D1/D0,1/Y)-1)*100;
      }
    }
    kRatio.textContent = fmt(ratio,3);
    kDelta.textContent = Number.isFinite(deltaPct)? fmt(deltaPct,2)+' %' : '—';
    kLin.textContent = Number.isFinite(lin)? fmt(lin,2)+' mm/año' : '—';
    kRel.textContent = Number.isFinite(rel)? fmt(rel,2)+' %/año' : '—';

    let vdt = NaN;
    if(useVol.checked && Number.isFinite(D0) && Number.isFinite(D1) && Number.isFinite(Y) && Y>0 && D0>0 && D1>0){
      const V0 = volSphere(D0), V1 = volSphere(D1);
      v0.value = fmt(mm3ToMl(V0),3);
      v1.value = fmt(mm3ToMl(V1),3);
      const k = (Math.log(V1) - Math.log(V0)) / Y;
      if(k>0) vdt = Math.log(2)/k;
    } else { v0.value=''; v1.value=''; }
    kVDT.textContent = Number.isFinite(vdt) ? fmt(vdt,2)+' años' : '—';

    // color señales
    kLin.parentElement.style.color = (Number.isFinite(lin) && lin>=5)? 'var(--warn)' : 'inherit';
    kVDT.parentElement.style.color = (Number.isFinite(vdt) && vdt<1)? 'var(--warn)' : 'inherit';
  }

  [date0,date1,d0,d1].forEach(el=>el.addEventListener('input', recalc));
  useVol.addEventListener('change', ()=>{ volRow.style.display = useVol.checked? 'grid':'none'; recalc(); });

  // Persistencia de casos
  const tbody = document.getElementById('casesTbody');
  function loadCases(){ try{ const a=JSON.parse(localStorage.getItem('srm_cases')||'[]'); return Array.isArray(a)?a:[];}catch{return []} }
  function saveCases(arr){ localStorage.setItem('srm_cases', JSON.stringify(arr)); }
  function round(x,d){ return Math.round(x*10**d)/10**d; }
  function isNum(x){ return typeof x==='number' && Number.isFinite(x); }

  function renderCases(){
    const arr = loadCases(); tbody.innerHTML='';
    arr.forEach((c,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.id||''}</td>
        <td>${c.date0||''} → ${c.date1||''}</td>
        <td>${c.d0} → ${c.d1}</td>
        <td>${c.ratio}</td>
        <td>${c.deltaPct} %</td>
        <td>${c.lin} mm/año</td>
        <td>${c.rel} %/año</td>
        <td>${c.vdt||'—'}</td>
        <td><button class="btn" data-del="${idx}">Borrar</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function exportCSV(){
    const arr = loadCases();
    const header = ['id','date0','date1','d0_mm','d1_mm','ratio','delta_pct_total','mm_por_ano','pct_anual','vdt_anos'];
    const lines = [header.join(',')].concat(arr.map(c=>[c.id||'',c.date0||'',c.date1||'',c.d0,c.d1,c.ratio,c.deltaPct,c.lin,c.rel,c.vdt||''].join(',')));
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='srm_ratio_cases.csv'; a.click(); URL.revokeObjectURL(url);
  }

  document.addEventListener('click',(e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if(btn.id==='clearBtn'){ ['date0','date1','d0','d1'].forEach(id=>document.getElementById(id).value=''); document.getElementById('useVol').checked=false; document.getElementById('volRow').style.display='none'; recalc(); }
    if(btn.id==='saveBtn'){
      const Y = yearsBetween(date0.value, date1.value);
      const D0 = parseFloat(d0.value), D1 = parseFloat(d1.value);
      if(!(Number.isFinite(D0)&&Number.isFinite(D1)&&D0>0)){ alert('Complete D₀ y D₁ válidos.'); return; }
      const ratio = D1/D0, deltaPct=(D1-D0)/D0*100;
      const lin = (Number.isFinite(Y)&&Y>0)? (D1-D0)/Y : '';
      const rel = (Number.isFinite(Y)&&Y>0)? (Math.pow(D1/D0,1/Y)-1)*100 : '';
      let vdt = '';
      if(useVol.checked && Number.isFinite(Y)&&Y>0){ const V0=volSphere(D0), V1=volSphere(D1), k=(Math.log(V1)-Math.log(V0))/Y; if(k>0) vdt=Math.log(2)/k; }
      const id = prompt('ID del paciente/caso (opcional)','');
      const arr = loadCases();
      arr.push({id,date0:date0.value,date1:date1.value,d0:D0,d1:D1,ratio:round(ratio,3),deltaPct:round(deltaPct,2),lin: isNum(lin)?round(lin,2):'', rel: isNum(rel)?round(rel,2):'', vdt: isNum(vdt)?round(vdt,2):''});
      saveCases(arr); renderCases();
    }
    if(btn.id==='exportBtn'){ exportCSV(); }
    if(btn.dataset && btn.dataset.del!==undefined){ const idx=parseInt(btn.dataset.del,10); const arr=loadCases(); arr.splice(idx,1); saveCases(arr); renderCases(); }
  });

  // PWA: registrar SW
  if('serviceWorker' in navigator){ window.addEventListener('load',()=> navigator.serviceWorker.register('./sw.js').catch(console.error)); }

  renderCases(); recalc();
})();
</script>
</body>
</html>

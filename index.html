<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SRM Ratio Calculator</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f7f7f7;
      color: #222;
      margin: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #004b87;
      margin-bottom: 1rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1.5rem;
      max-width: 420px;
      width: 100%;
      margin-bottom: 1rem;
    }
    label {
      display: block;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    input {
      width: 100%;
      padding: 0.4rem;
      margin-top: 0.2rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .kpi {
      background: #f2f6fc;
      border-radius: 8px;
      padding: 0.6rem 1rem;
      margin-top: 0.6rem;
    }
    .kpi .t {
      font-size: 0.9rem;
      color: #666;
    }
    .kpi .v {
      font-size: 1.2rem;
      font-weight: bold;
      color: #004b87;
    }
    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      background-color: #004b87;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }
    button:hover {
      background-color: #0060b3;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <h1>SRM Ratio Calculator</h1>

  <div class="card">
    <label>Fecha A</label>
    <input type="date" id="date0">

    <label>DiÃ¡metro A (mm)</label>
    <input type="number" id="d0" step="0.1">

    <label>Fecha B</label>
    <input type="date" id="date1">

    <label>DiÃ¡metro B (mm)</label>
    <input type="number" id="d1" step="0.1">

    <div class="kpi">
      <div class="t">Ratio</div>
      <div class="v" id="kRatio">â€”</div>
    </div>

    <div class="kpi">
      <div class="t">Î” %</div>
      <div class="v" id="kDelta">â€”</div>
    </div>

    <div class="kpi">
      <div class="t">Crecimiento lineal (mm/aÃ±o)</div>
      <div class="v" id="kLin">â€”</div>
    </div>

    <div class="kpi">
      <div class="t">% anual</div>
      <div class="v" id="kRel">â€”</div>
    </div>

    <div class="kpi">
      <div class="t">Vol Doubling Time (aÃ±os)</div>
      <div class="v" id="kVDT">â€”</div>
    </div>

    <!-- NUEVO KPI: GR lineal (cm/aÃ±o) -->
    <div class="kpi">
      <div class="t">GR lineal (cm/aÃ±o)</div>
      <div class="v" id="kGRcm">â€”</div>
    </div>

    <small id="grDetails" style="display:block;margin-top:6px;color:#555"></small>
    <div id="grBadge" style="margin-top:6px;font-weight:700"></div>

    <details>
      <summary>Umbrales del semÃ¡foro</summary>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <label>Verde â‰¤
          <input id="thr_green" type="number" step="0.01" value="0.0">
        </label>
        <label>Amarillo â‰¤
          <input id="thr_yellow" type="number" step="0.01" value="0.5">
        </label>
      </div>
      <small>Regla: verde â‰¤ lÃ­mite â†’ âœ…; â‰¤ amarillo â†’ âš ï¸; > amarillo â†’ ðŸ”´</small>
    </details>

    <button onclick="resetForm()">Limpiar</button>
  </div>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);
    const date0=$('date0'), date1=$('date1'), d0=$('d0'), d1=$('d1');
    const kRatio=$('kRatio'), kDelta=$('kDelta'), kLin=$('kLin'),
          kRel=$('kRel'), kVDT=$('kVDT'), kGRcm=$('kGRcm'),
          grDetails=$('grDetails'), grBadge=$('grBadge');

    function yearsBetween(a,b){
      if(!a||!b) return NaN;
      const A=new Date(a), B=new Date(b);
      return (B-A)/(1000*60*60*24*365.25);
    }
    function monthsBetween(a,b){
      return (b-a)/(1000*60*60*24*30.4375);
    }
    function fmt(x,d=2){return Number.isFinite(x)?x.toFixed(d):'â€”';}

    function gradeByThresholds(gr){
      const g=parseFloat($('thr_green').value||'0.0');
      const y=parseFloat($('thr_yellow').value||'0.5');
      if(!Number.isFinite(gr)) return {label:'',color:''};
      if(gr<=g) return {label:"âœ… Verde (estable)",color:"#16a34a"};
      if(gr<=y) return {label:"âš ï¸ Amarillo (vigilancia)",color:"#ca8a04"};
      return {label:"ðŸ”´ Rojo (crecimiento alto)",color:"#dc2626"};
    }

    function recalc(){
      const D0=parseFloat(d0.value), D1=parseFloat(d1.value);
      const A=date0.value, B=date1.value;
      const Y=yearsBetween(A,B);

      let ratio=NaN, deltaPct=NaN, lin=NaN, rel=NaN, vdt=NaN, gr=NaN;

      if(Number.isFinite(D0)&&Number.isFinite(D1)&&D0>0){
        ratio=D1/D0;
        deltaPct=(D1-D0)/D0*100;
        if(Number.isFinite(Y)&&Y>0){
          lin=(D1-D0)/Y;
          rel=(Math.pow(D1/D0,1/Y)-1)*100;
        }
      }

      kRatio.textContent=fmt(ratio,3);
      kDelta.textContent=fmt(deltaPct,2)+' %';
      kLin.textContent=fmt(lin,2)+' mm/aÃ±o';
      kRel.textContent=fmt(rel,2)+' %/aÃ±o';
      kVDT.textContent='â€”';

      // GR lineal en cm/aÃ±o
      if(Number.isFinite(D0)&&Number.isFinite(D1)&&A&&B){
        const dA=new Date(A), dB=new Date(B);
        if(dB>dA){
          const deltaCm=(D1-D0)/10;
          const meses=monthsBetween(dA,dB);
          if(meses>0){
            gr=(deltaCm/meses)*12;
            kGRcm.textContent=fmt(gr,2)+' cm/aÃ±o';
            grDetails.textContent=`Î”=${fmt(deltaCm,2)} cm Â· ${fmt(meses,2)} meses`;
            const g=gradeByThresholds(gr);
            grBadge.innerHTML=g.label;
            grBadge.style.color=g.color;
          }
        }
      }

      if(!Number.isFinite(gr)){
        kGRcm.textContent='â€”';
        grDetails.textContent='';
        grBadge.textContent='';
      }
    }

    [date0,date1,d0,d1].forEach(e=>e.addEventListener('input',recalc));
    $('thr_green').addEventListener('input',recalc);
    $('thr_yellow').addEventListener('input',recalc);

    window.resetForm=function(){
      [date0,date1,d0,d1].forEach(e=>e.value='');
      recalc();
    };

    recalc();
  })();
  </script>
</body>
</html>

<script>
  // Thresholds (unchanged)
  const TH_GR_VERDE    = 0.3;
  const TH_GR_AMARILLO = 0.5;
  const TH_GR_NARANJA  = 1.0;
  const UMBRAL_ALTO_CM_ANO = TH_GR_NARANJA;
  const UMBRAL_CORTO_DIAS  = 45;
  const UMBRAL_CORTO_GR    = TH_GR_AMARILLO;

  // === NEW: date helpers and input max limit ===
  function hoyISO() {
    const d = new Date();
    d.setHours(0,0,0,0);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function clampFechaFutura(inputEl) {
    const max = hoyISO();
    if (!inputEl.value) return;
    if (inputEl.value > max) {
      inputEl.value = max;
      console.warn('Future date detected. Adjusted to today:', max);
    }
  }

  function prepararFechas() {
    const fa = document.getElementById('fechaA');
    const fb = document.getElementById('fechaB');
    const max = hoyISO();
    fa.setAttribute('max', max);
    fb.setAttribute('max', max);
    fa.addEventListener('input', () => clampFechaFutura(fa));
    fb.addEventListener('input', () => clampFechaFutura(fb));
    fa.addEventListener('change', () => clampFechaFutura(fa));
    fb.addEventListener('change', () => clampFechaFutura(fb));
    clampFechaFutura(fa);
    clampFechaFutura(fb);
  }

  document.addEventListener('DOMContentLoaded', prepararFechas);

  // === Calculation (with extra date check) ===
  function calcularGR() {
    const faEl = document.getElementById("fechaA");
    const fbEl = document.getElementById("fechaB");
    const A = parseFloat(document.getElementById("diamA").value);
    const B = parseFloat(document.getElementById("diamB").value);

    if (!faEl.value || !fbEl.value || isNaN(A) || isNaN(B)) {
      alert("Please complete all fields.");
      return;
    }

    const max = hoyISO();
    if (faEl.value > max || fbEl.value > max) {
      alert("Dates cannot be in the future.");
      prepararFechas();
      return;
    }

    const fechaA = new Date(faEl.value);
    const fechaB = new Date(fbEl.value);
    const diffMs = fechaB - fechaA;
    const dias = diffMs / (1000 * 60 * 60 * 24);

    if (dias <= 0) {
      alert("Follow-up date must be later than the initial date.");
      return;
    }

    const meses = dias / 30.437;
    const GR = ((B - A) / meses) * 12; // cm/year

    mostrarResultado(GR, dias, meses);
    updatePitfalls(GR, dias, meses);
  }

  // === Display result ===
  function mostrarResultado(GR, dias, meses) {
    const res = document.getElementById("resultado");
    let color = "verde";
    let texto = "Stable growth rate";
    if (GR > TH_GR_VERDE && GR <= TH_GR_AMARILLO) {
      color = "amarillo"; texto = "Slow growth (monitor)";
    } else if (GR > TH_GR_AMARILLO && GR <= TH_GR_NARANJA) {
      color = "rojo"; texto = "Significant growth";
    } else if (GR > TH_GR_NARANJA) {
      color = "rojo"; texto = "Biologically implausible growth rate";
    }
    res.innerHTML = `
      <p class="${color}">LGR = ${GR.toFixed(2)} cm/year</p>
      <p>${texto}</p>
    `;
  }

  // === Add “pitfalls” clinical context ===
  function updatePitfalls(GR, dias, meses) {
    const box = document.getElementById("pitfalls");
    if (!box) return;
    let severity = null;
    if (GR > UMBRAL_ALTO_CM_ANO) severity = "danger";
    else if (dias < UMBRAL_CORTO_DIAS && GR > UMBRAL_CORTO_GR) severity = "warn";
    if (!severity) { 
      box.style.display = "none"; 
      box.className = "pitfalls"; 
      box.innerHTML = ""; 
      return; 
    }
    box.className = "pitfalls" + (severity === "danger" ? " pitfalls--danger" : "");
    box.innerHTML = `
      <h3>Clinical interpretation</h3>
      <ul>
        <li>The estimated rate is <strong>${severity === "danger" ? "biologically implausible" : "atypical"}</strong> for SRM under active surveillance. Average expected rate: <strong>~0.3–0.5 cm/year</strong>.</li>
        <li>A sharp increase within <strong>${dias} days</strong> (≈ ${meses.toFixed(2)} months) usually <strong>does not represent real tumor growth</strong> but may result from:
          <ul>
            <li><strong>Measurement variability</strong> (different slice plane or imaging phase).</li>
            <li><strong>Intratumoral hemorrhage or transient inflammation.</strong></li>
            <li><strong>Segmentation or registration error</strong> between studies.</li>
          </ul>
        </li>
        <li>Review imaging methodology and confirm with a short-term follow-up if doubt persists.</li>
      </ul>`;
    box.style.display = "block";
  }

  // === Reset form ===
  function resetForm() {
    document.getElementById("fechaA").value = "";
    document.getElementById("fechaB").value = "";
    document.getElementById("diamA").value = "";
    document.getElementById("diamB").value = "";
    document.getElementById("resultado").innerHTML = "";
    const box = document.getElementById("pitfalls");
    box.style.display = "none"; 
    box.className = "pitfalls"; 
    box.innerHTML = "";
    prepararFechas();
  }
</script>
